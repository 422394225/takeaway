<#include "../base/main/_main.html"/>
<#assign wxMeta>
</#assign>
<#assign wxCss>
<link href="${base}/resources/stylesheets/wx_front.css" rel="stylesheet" type="text/css" />
</#assign>
<#assign wxJavascript>
	<script src="${base}/resources/javascripts/lay/laytpl.js" type="text/javascript"></script>
<script>
$(function(){
    var foodTypes = new Object();
    $(".leftBar-item").each(function () {
        var typeInfo = new Object();
        typeInfo.id = $(this).attr("data-id");
        typeInfo.name = $(this).text().trim();
        loadFood(typeInfo);
        var typeId = $(this).attr("data-id");
        //保存偏移
        var offsetTop = $("#type"+typeId).position().top;
        foodTypes[typeId] = offsetTop;
        foodTypes["o-"+offsetTop] = typeId;
    })
    $(".leftBar-item").on("click",function (e) {
        setActive($(this));
        var typeId = $(this).attr("data-id");
		$(".rightList").animate({scrollTop:foodTypes[typeId]},300);
        e.stopPropagation();
    })
   /* $(".rightList").scroll(function(e) {
        var scrollTop = $(".rightList").scrollTop();
        var position = 0;
        var lastId =  foodTypes["o-"+position];
        for(var id in foodTypes){
            if(position<=scrollTop<=foodTypes[id]){
                setActive($("div[data-id='"+lastId+"']"));
                return;
			}
            position = foodTypes[id];
            lastId =  foodTypes["o-"+position];
		}
    });*/


    $(".add2cart").on("click",function (e) {
        var amountOfFood = Number($(this).siblings(".amountOfFood").text()) ;
        amountOfFood++;
        $(this).siblings(".amountOfFood").text(amountOfFood);
        $(this).siblings(".amountOfFood").show();
        $(this).siblings(".minus2cart").show();
    })
    $(".minus2cart").on("click",function (e) {
        var amountOfFood = Number($(this).siblings(".amountOfFood").text()) ;
        amountOfFood--;
        $(this).siblings(".amountOfFood").text(amountOfFood);
        if(amountOfFood<=0){
            $(this).siblings(".amountOfFood").hide();
            $(this).hide();
        }
    })
})
function setActive(dom) {
    $(".leftBar-item").removeClass("active");
    dom.addClass("active");
}
function loadFood(typeInfo) {
	Kit.post("${base}/wx/food/ajaxFoodByType",{id:typeInfo.id},function (msg,data) {
	    var info = new Object();
	    info.typeInfo = typeInfo;
	    info.data = data;
		renderFood(info);
	},function (msg,data) {
		$.alert(msg)
	},{async:false})
}
function renderFood(info) {
    var tpl = $('#food-tpl').html();
    laytpl(tpl).render(info, function(html){
        $(".rightList").append(html);
    });
}

</script>
</#assign>
<@mainLayout wxTitle=shop.NAME wxMeta=wxMeta wxCss=wxCss wxJavascript=wxJavascript>
<div class="page page-current" id="mainPage">
	<div class="content bg-default">
		<div class="pageContent bg-default">
			<div class="shopInfo bg-primary">
				<div class="topContainer">
					<div class="logo">
						<img src="${(shop.IMG)!}"/>
					</div>
					<div class="">

					</div>
				</div>
			</div>
			<div class="leftBar">
				<#list types as type>
					<div class="leftBar-item <#if type_index==0>active</#if>" data-id="${(type.ID)!}">
						${(type.NAME)!}
					</div>
				</#list>
			</div>
			<div class="rightList">

			</div>
			<div class="cart-wrapper"></div>
			<div class="cart">
				<img src="${base}/resources/images/shopping_cart.png"/>
			</div>
		</div>
	</div>
</div>
<script id="food-tpl" type="text/html">
	<div class="content-block-title" id="type{{d.typeInfo.id}}" style="margin:.75rem .75rem .5rem">
		{{d.typeInfo.name}}
	</div>
	{{# for(var i = 0, len = d.data.length; i < len; i++){ }}
    <div class="card no-margin">
        <div class="card-content">
			<div class="list-block media-list">
				<ul>
					<li class="item-content">
						<div class="item-media">
							<img src="{{d.data[i].IMG}}" width="60">
						</div>
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title" style="width: 100%">
									<div class="row no-gutter">
										<div class="col-100">
											{{d.data[i].NAME}}
											<div style="font-size: .65rem !important;float: right">&nbsp;已售{{d.data[i].SALE_NUM}}单</div>
										</div>
									</div>
								</div>
							</div>
							<div class="item-subtitle">
								<span style="color:#a9a9a9;font-size:.5rem;">{{d.data[i].DESCRIPTION}}</span>
							</div>
							<div class="item-subtitle">
								售价:
								{{# if(d.data[i].ORIGN_PRICE!=d.data[i].PRICE){ }}
								<font color="gray" style="text-decoration:line-through">￥{{d.data[i].ORIGN_PRICE}}</font>
								{{# } }}
								<font color="#ef3204">￥{{d.data[i].PRICE}}</font>
								<span>/{{d.data[i].UNIT}}</span>
							</div>
							<div class="item-subtitle cartOp" data-id="{{d.data[i].ID}}" data-img="{{d.data[i].IMG}}">
								<span class="fa fa-minus-circle color-primary minus2cart" style="display: none"></span>
								<span class="color-success amountOfFood" style="display: none">0</span>
								<span class="fa fa-plus-circle color-primary add2cart"></span>
							</div>
						</div>
					</li>
				</ul>
			</div>
        </div>
	</div>
	{{# } }}
</script>
</@mainLayout>