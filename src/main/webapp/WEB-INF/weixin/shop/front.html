<#include "../base/main/_main.html"/>
<#assign wxMeta>
</#assign>
<#assign wxCss>
<link href="${base}/resources/stylesheets/wx_front.css" rel="stylesheet" type="text/css" />
</#assign>
<#assign wxJavascript>
	<script src="${base}/resources/javascripts/lay/laytpl.js" type="text/javascript"></script>
	<script src="${base}/resources/jQuery/raty/jquery.raty.min.js" type="text/javascript"></script>
	<script src="${base}/resources/javascripts/draggabilly.pkgd.min.js" type="text/javascript"></script>
<script>
$(function(){
    var foodTypes = new Object();
    $(".leftBar-item").each(function () {
        var typeInfo = new Object();
        typeInfo.id = $(this).attr("data-id");
        typeInfo.name = $(this).text().trim();
        loadFood(typeInfo);
        var typeId = $(this).attr("data-id");
        //保存偏移
        var offsetTop = $("#type"+typeId).position().top;
        foodTypes[typeId] = offsetTop;
        foodTypes["o-"+offsetTop] = typeId;
    })
    $(".leftBar-item").on("click",function (e) {
        setActive($(this));
        var typeId = $(this).attr("data-id");
		$(".rightList").animate({scrollTop:foodTypes[typeId]},300);
        e.stopPropagation();
    })
	//TODO 滚动联动分类
   /* $(".rightList").scroll(function(e) {
        var scrollTop = $(".rightList").scrollTop();
        var position = 0;
        var lastId =  foodTypes["o-"+position];
        for(var id in foodTypes){
            if(position<=scrollTop<=foodTypes[id]){
                setActive($("div[data-id='"+lastId+"']"));
                return;
			}
            position = foodTypes[id];
            lastId =  foodTypes["o-"+position];
		}
    });*/

   //店铺的星级
    $('div[data-score]').raty({
        readOnly: true,
        score: function() {
            return $(this).attr('data-score');
        }
    });

    $(".add2cart").on("click",function (e) {
        var amountOfFood = Number($(this).siblings(".amountOfFood").text()) ;
        amountOfFood++;
        $(this).siblings(".amountOfFood").text(amountOfFood);
        $(this).siblings(".amountOfFood").show();
        $(this).siblings(".minus2cart").show();
        $("#cart .count").text(Number($("#cart .count").text())+1);
        var price = Number($(this).parent().attr("data-price"));
        debugger
        $("#cart .pay").text(Number($("#cart .pay").text())+price);
    })
    $(".minus2cart").on("click",function (e) {
        var amountOfFood = Number($(this).siblings(".amountOfFood").text()) ;
        amountOfFood--;
        $(this).siblings(".amountOfFood").text(amountOfFood);
        if(amountOfFood<=0){
            $(this).siblings(".amountOfFood").hide();
            $(this).hide();
        }
        $("#cart .count").text(Number($("#cart .count").text())-1);
        var price = Number($(this).parent().attr("data-price"));
        $("#cart .pay").text(Number($("#cart .pay").text())-price);
    })
    $('#cart').draggabilly({

	});
})
function setActive(dom) {
    $(".leftBar-item").removeClass("active");
    dom.addClass("active");
}
function loadFood(typeInfo) {
	Kit.post("${base}/wx/food/ajaxFoodByType",{id:typeInfo.id},function (msg,data) {
	    var info = new Object();
	    info.typeInfo = typeInfo;
	    info.data = data;
		renderFood(info);
	},function (msg,data) {
		$.alert(msg)
	},{async:false})
}
function renderFood(info) {
    var tpl = $('#food-tpl').html();
    laytpl(tpl).render(info, function(html){
        $(".rightList").append(html);
    });
}

</script>
</#assign>
<@mainLayout wxTitle=shop.NAME wxMeta=wxMeta wxCss=wxCss wxJavascript=wxJavascript>
<div class="page page-current" id="mainPage">
	<div class="content bg-default">
		<div class="pageContent bg-default">
			<div class="shopInfo bg-primary">
				<div class="topContainer">
					<table>
						<tr style="font-size: 1rem;font-weight: bold">
							<td rowspan="4">
								<img src="${(shop.IMG)!}" width="120em"/>
							</td>
							<td colspan="3">
								<span>${(shop.NAME)!}</span>
							</td>
						</tr>
						<tr>
							<td>
								<span><font color="#ffd700">${(shop.DELIVERY_THRESHOLD)!}</font>元起送</span>
							</td>
							<td>
								<span><font class="color-success">${(shop.DELIVERYED_TIME)!}分钟</font>送达</span>
							</td>
							<td>
								<span>配送费<font color="#ff8c00">${(shop.DELIVERY_PRICE)!}</font>元</span>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<div data-score="${(shop.RATE_AVG)!}"></div>
							</td>
							<td>${(shop.RATE_AVG)!}分</td>
						</tr>
						<tr>
							<td colspan="2">
								<span>已售${(shop.SALE_NUM)!}单</span>
							</td>
								<td>
									<#assign n = 0 >
									<#if shop.REDUCTION gt 0><#assign n+=1 ></#if>
									<#if shop.DELIVERY_OFF gt 0><#assign n+=1 ></#if>
									<#if shop.GIFT?? && shop.GIFT!=''><#assign n+=1 ></#if>
									<div class="open-popover color-default" data-popup=".popover-activities" data-placement="bottom">
										${n}个活动&nbsp;<#if n gt 0><i class="fa fa-chevron-down"></i></#if>
									</div>
								</td>
						</tr>
					</table>
					<div class="popover popover-activities">
						<div class="popover-angle"></div>
						<div class="popover-inner bg-default" style="border-radius: 5px;border: 1px solid #0894ec">
							<#if shop.REDUCTION gt 0>
							<div class="card-footer" style="border: 0px">
								<badge class="bg-primary">满</badge>&nbsp;满${shop.REDUCTION_THRESHOLD}元,优惠<font class="color-primary">${shop.REDUCTION}</font>元
							</div>
							</#if>
							<#if shop.DELIVERY_OFF gt 0>
							<div class="card-footer">
								<badge class="bg-warning">配</badge>&nbsp;满${shop.DELIVERY_OFF_THRESHOLD}元,减配送费<font class="color-warning">${shop.DELIVERY_OFF}</font>元
							</div>
							</#if>
							<#if shop.GIFT?? && shop.GIFT!=''>
							<div class="card-footer">
								<badge class="bg-danger">赠</badge>&nbsp;满${shop.GIFT_THRESHOLD}元,送<font class="color-danger">${shop.GIFT}</font>
							</div>
							</#if>
						</div>
					</div>
				</div>
			</div>
			<div class="leftBar">
				<#list types as type>
					<div class="leftBar-item <#if type_index==0>active</#if>" data-id="${(type.ID)!}">
						${(type.NAME)!}
					</div>
				</#list>
			</div>
			<div class="rightList"></div>
		</div>
	</div>
	<div id="cart">
		<div class="color-primary count">0</div>
		<div class="color-warning amount">￥<span class="pay">0</span></div>
	</div>
</div>
<script id="food-tpl" type="text/html">
	<div class="content-block-title" id="type{{d.typeInfo.id}}" style="margin:.75rem .75rem .5rem">
		{{d.typeInfo.name}}
	</div>
	{{# for(var i = 0, len = d.data.length; i < len; i++){ }}
    <div class="card no-margin">
        <div class="card-content">
			<div class="list-block media-list">
				<ul>
					<li class="item-content">
						<div class="item-media">
							<img src="{{d.data[i].IMG}}" width="60">
						</div>
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title" style="width: 100%">
									<div class="row no-gutter">
										<div class="col-100">
											{{d.data[i].NAME}}
											<div style="font-size: .65rem !important;float: right">&nbsp;已售{{d.data[i].SALE_NUM}}单</div>
										</div>
									</div>
								</div>
							</div>
							<div class="item-subtitle">
								<span style="color:#a9a9a9;font-size:.5rem;">{{d.data[i].DESCRIPTION}}</span>
							</div>
							<div class="item-subtitle">
								售价:
								{{# if(d.data[i].ORIGN_PRICE!=d.data[i].PRICE){ }}
								<font color="gray" style="text-decoration:line-through">￥{{d.data[i].ORIGN_PRICE}}</font>
								{{# } }}
								<font color="#ef3204">￥{{d.data[i].PRICE}}</font>
								<span>/{{d.data[i].UNIT}}</span>
							</div>
							<div class="item-subtitle cartOp" data-id="{{d.data[i].ID}}" data-img="{{d.data[i].IMG}}"  data-price="{{d.data[i].PRICE}}">
								<span class="fa fa-minus-circle color-primary minus2cart" style="display: none"></span>
								<span class="color-warning amountOfFood" style="display: none">0</span>
								<span class="fa fa-plus-circle color-primary add2cart"></span>
							</div>
						</div>
					</li>
				</ul>
			</div>
        </div>
	</div>
	{{# } }}
</script>
</@mainLayout>