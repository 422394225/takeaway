<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>根据ip定位</title>
    <style>
    	#pickerInput{
    		position:absolute !important;
    		top:30px;
    		right:30px;
    		width:auto;
    	}
    	.amap-sug-result{
    		z-index: 9999;
    	}
    </style>
</head>
<body>
<div id="container" style="height: 450px;">
</div>
<input class="form-control col-lg-3 col-md-3 col-sm-6" id="pickerInput" placeholder="搜索..." onfocus='this.value=""'/>
<script src="http://webapi.amap.com/maps?v=1.3&key=04c33f8c52343253167be2dd826f5be8&plugin=AMap.Autocomplete,AMap.Geocoder&callback=mapInit" type="text/javascript"></script>
<script src="${base}/resources/javascripts/main-async.js"></script>
<script type="text/javascript">
	var map;
	var currentPoi = {};
	function mapInit(){
		initAMapUI();//异步组件调用
		map = new AMap.Map("container", {
	        resizeEnable: true,
	        zoom: 13
	    });//初始化地图
	 
		//基础控件
		map.plugin(['AMap.Scale','AMap.CitySearch',"AMap.ToolBar"], function() {
            map.addControl(new AMap.Scale());
            map.addControl(new AMap.CitySearch());
            map.addControl(new AMap.ToolBar());
        });
		//输入提示
	    var autoOptions = {
	        input: "mapSearch"
	    };
		
	    AMapUI.loadUI(['misc/PoiPicker'], function(PoiPicker) {
	        var poiPicker = new PoiPicker({
	            input: 'pickerInput'
	        });
	        //初始化poiPicker
	        poiPickerReady(poiPicker);
	    });
	    
	    //初始化标记
	    var marker = new AMap.Marker({
    		icon:"http://webapi.amap.com/theme/v1.3/markers/n/mark_r.png",
    		title: "店铺位置",
    		zIndex:1000,
    		animation:"AMAP_ANIMATION_DROP",
    		map: map
		});
	    //初始化信息窗体
	    var infoWindow = new AMap.InfoWindow({
            offset: new AMap.Pixel(0, -20)
        });
	    var geocoder = new AMap.Geocoder({
            radius: 1000,
            extensions: "all"
        });  
	    getAddressInfo(map.getCenter());//显示当前位置信息窗体

	    map.on('click', function(e) {
	    	infoWindow.close();
	    	marker.setPosition(e.lnglat);
	    	getAddressInfo(e.lnglat)
	    });
	    
	    function poiPickerReady(poiPicker) {
	        window.poiPicker = poiPicker;
	        
	        //选取了某个POI
	        poiPicker.on('poiPicked', function(poiResult) {
	            marker.setMap(map);
	            infoWindow.setMap(map);
	            var poi = poiResult.item;
	            marker.setPosition(poi.location);
	            infoWindow.setPosition(poi.location);
	            infoWindow.setContent(poi.name+"<br>地址："+poi.address);
	            infoWindow.open(map, marker.getPosition());

	            map.setCenter(marker.getPosition());
	        });

	    }
		
	    function getAddressInfo(lnglat){
			geocoder.getAddress(lnglat, function(status, result) {
	            if (status === 'complete' && result.info === 'OK') {
	            	currentPoi = result.regeocode;
	            	currentPoi.lat = lnglat.lat;
		            currentPoi.lng = lnglat.lng;
	            	var address = currentPoi.formattedAddress;
	            	infoWindow.setPosition(lnglat);
		            infoWindow.setContent("地址："+address);
		            infoWindow.open(map, lnglat);
	            }
	        });
		}
		return map;
	}
	
	
	 $("#localBtn").on("click",function() {
		 //实例化城市查询类
        var citysearch = new AMap.CitySearch();
        //自动获取用户IP，返回当前城市
        citysearch.getLocalCity(function(status, result) {
            if (status === 'complete' && result.info === 'OK') {
                if (result && result.city && result.bounds) {
                    var cityinfo = result.city;
                    var citybounds = result.bounds;
                    //地图显示当前城市
                    map.setBounds(citybounds);
                }
            }
        });		 
    });
	 
	 $("#submitLocalBtn").on("click",function() {
		 $("#latitude").val(currentPoi.lat)
		 $("#longitude").val(currentPoi.lng)
		 $("#addressCode").val(currentPoi.addressComponent.adcode)
		 $("#address").val(currentPoi.formattedAddress.toString());
    });
</script>
</body>
</html>